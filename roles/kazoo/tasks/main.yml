---
- include_vars: secrets.yml

- name: Install HAProxy
  yum:
    name: kazoo-haproxy
    state: latest

- name: Create HAProxy haproxy.cfg
  template:
    src: haproxy.cfg.j2
    dest: /etc/kazoo/haproxy/haproxy.cfg
  notify: Restart HAProxy

- name: Start and Enable HAProxy
  service:
    name: kazoo-haproxy
    state: started
    enabled: yes

- name: Install Kazoo
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
   - kazoo-applications
   - kazoo-application-*

- name: Create Kazoo config.ini
  template:
    src: config.ini.j2
    dest: /etc/kazoo/core/config.ini
  notify: Restart Kazoo

- name: Start and Enable Kazoo Applications
  service:
    name: kazoo-applications
    state: started
    enabled: yes

- name: Start and Enable ecallmgr
  service:
    name: kazoo-ecallmgr
    state: started
    enabled: yes

- name: Allow epmd Port
  firewalld:
    port: 4369/tcp
    permanent: true
    immediate: true
    state: enabled

- name: Allow Distributed Erlang Ports
  firewalld:
    port: 11500-11999/tcp
    permanent: true
    immediate: true
    state: enabled

- name: Install Nginx
  yum:
    name: nginx
    state: latest

- name: Create nginx.conf
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: Restart Nginx

- name: Start and Enable Nginx
  service:
    name: nginx
    state: started
    enabled: yes

- name: Install MonsterUI
  yum:
    name: monster-ui*
    state: latest

- name: Allow Http Port
  firewalld:
    port: 80/tcp
    permanent: true
    immediate: true
    state: enabled

- name: Allow Httpd to Connect to the Network
  shell: setsebool -P httpd_can_network_connect 1
  changed_when: false

- name: Create MonsterUI config.js
  template:
    src: config.js.j2
    dest: /var/www/html/monster-ui/js/config.js

